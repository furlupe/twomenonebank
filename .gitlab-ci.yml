stages:
  - build
  - deploy

variables:
  IMAGE_NAME: happypiece/twomenonebank
  CORE_TAG: core

.build:
  tags:
    - build
    - docker
  stage: build
  rules:
    - if: $CI_COMMIT_REF_NAME != "develop"
      when: manual
    - when: always
  image: docker:25.0
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  services:
    - name: docker:25.0-dind
      command: ["--tls=false"]
  before_script:
    - docker info
    - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  after_script:
    - echo 'Initiating cleanup...'
    - docker system prune -f
    - docker logout
    - echo 'Cleanup completed.'

build-core:
  extends: .build
  script:
    - echo 'Building Core service...'
    - docker build . --rm -f svc_Core/Core.dockerfile -t $IMAGE_NAME:$CORE_TAG
    - echo 'Builds completed, pushing to registry...'
    - docker push $IMAGE_NAME:$CORE_TAG
    - echo 'Build completed.'

deploy:
  tags:
    - deploy
    - shell
  stage: deploy
  rules:
    - if: $CI_COMMIT_REF_NAME != "develop"
      when: manual
    - when: on_success
  before_script:
    - docker info
  script:
    - echo 'Deploying services...'
    - docker compose create
    - docker cp $CORE_APPSETTINGS twomenonebank-core-app:/app/appsettings.Staging.json
    - docker compose start
    - echo 'Deploy completed.'
  after_script:
    - echo 'Initiating cleanup...'
    - docker system prune -f
    - echo 'Cleanup completed.'
